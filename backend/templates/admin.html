<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - FlexTransfer Hub</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üëë</text></svg>"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        color: #667eea;
        font-size: 2rem;
        font-weight: 700;
      }

      .admin-badge {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .nav-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
      }

      .nav-tab {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        padding: 15px 25px;
        border-radius: 15px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        color: #666;
      }

      .nav-tab.active {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-icon {
        font-size: 3rem;
        margin-bottom: 15px;
      }

      .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 10px;
      }

      .stat-label {
        color: #666;
        font-weight: 600;
      }

      .content-panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        display: none;
      }

      .content-panel.active {
        display: block;
      }

      .table-container {
        overflow-x: auto;
        border-radius: 15px;
        background: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        max-height: 600px; /* Gi·ªõi h·∫°n chi·ªÅu cao */
        overflow-y: auto; /* Cho ph√©p scroll d·ªçc */
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
        vertical-align: middle; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
      }

      th {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        font-weight: 600;
        position: sticky; /* Gi·ªØ header c·ªë ƒë·ªãnh khi scroll */
        top: 0;
        z-index: 10;
      }

      tr:hover {
        background: rgba(102, 126, 234, 0.05);
      }

      /* C·∫£i thi·ªán layout cho c·ªôt thao t√°c */
      .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        min-width: 280px; /* ƒê·∫£m b·∫£o ƒë·ªß kh√¥ng gian */
      }

      .action-buttons .btn,
      .action-buttons .btn-preview,
      .action-buttons .btn-download {
        flex: 1;
        min-width: 80px;
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 12px;
        transition: all 0.3s ease;
        text-align: center;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }

      .action-buttons .btn-preview {
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
      }

      .action-buttons .btn-download {
        background: linear-gradient(45deg, #2ecc71, #27ae60);
        color: white;
      }

      /* Scroll bar styling */
      .table-container::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      .table-container::-webkit-scrollbar-thumb {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border-radius: 10px;
      }

      .table-container::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(45deg, #5a67d8, #6b46c1);
      }

      /* Responsive design cho c√°c m√†n h√¨nh nh·ªè */
      @media (max-width: 768px) {
        .action-buttons {
          flex-direction: column;
          min-width: 120px;
        }

        .action-buttons .btn,
        .action-buttons .btn-preview,
        .action-buttons .btn-download {
          width: 100%;
          min-width: unset;
        }

        .table-container {
          max-height: 400px;
        }
      }

      .btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-danger {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
      }

      .btn-warning {
        background: linear-gradient(45deg, #f39c12, #e67e22);
      }

      .btn-success {
        background: linear-gradient(45deg, #2ecc71, #27ae60);
      }

      .search-bar {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.9);
        margin-bottom: 20px;
        font-size: 16px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .user-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        display: inline-block;
      }

      .user-badge.admin {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
      }

      .user-badge.user {
        background: linear-gradient(45deg, #2ecc71, #27ae60);
        color: white;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        background: white;
        margin: 10% auto;
        padding: 30px;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      /* Beautiful dropdown styling */
      #file-user-filter {
        background: linear-gradient(145deg, #ffffff, #f0f0f0);
        border: 2px solid #e0e6ff;
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 14px;
        font-weight: 500;
        color: #333;
        min-width: 200px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
      }

      #file-user-filter:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        transform: translateY(-1px);
      }

      #file-user-filter:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      /* Preview button styling */
      .btn-preview {
        background: linear-gradient(145deg, #6c5ce7, #a29bfe);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        font-size: 13px;
        margin-right: 5px;
      }

      .btn-preview:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 92, 231, 0.4);
        background: linear-gradient(145deg, #5f4fd4, #918bfc);
      }

      /* Download button styling */
      .btn-download {
        background: linear-gradient(145deg, #00b894, #00cec9);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        font-size: 13px;
        margin-right: 5px;
      }

      .btn-download:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 184, 148, 0.4);
        background: linear-gradient(145deg, #009c84, #00b2a9);
      }

      /* Preview Modal Styles */
      .preview-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        backdrop-filter: blur(5px);
      }

      .preview-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }

      .preview-content {
        background: white;
        border-radius: 20px;
        padding: 20px;
        max-width: 90%;
        max-height: 90%;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .preview-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin: 0;
      }

      .preview-close {
        background: #ff6b6b;
        color: white;
        border: none;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .preview-close:hover {
        background: #ff5252;
        transform: scale(1.1);
      }

      .preview-body {
        max-height: 70vh;
        overflow: auto;
      }

      .preview-image {
        max-width: 100%;
        max-height: 70vh;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .preview-pdf {
        width: 100%;
        height: 70vh;
        border: none;
        border-radius: 10px;
      }

      .preview-video {
        max-width: 100%;
        max-height: 70vh;
        border-radius: 10px;
      }

      .preview-audio {
        width: 100%;
        border-radius: 10px;
      }

      .preview-text {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        line-height: 1.5;
        max-height: 60vh;
        overflow: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .preview-download {
        text-align: center;
        padding: 40px 20px;
      }

      .preview-icon {
        font-size: 4rem;
        margin-bottom: 20px;
      }

      .preview-download-info h3 {
        margin-bottom: 10px;
        color: #333;
      }

      .preview-download-info p {
        color: #666;
        margin-bottom: 8px;
      }

      .preview-download-btn {
        background: linear-gradient(145deg, #00b894, #00cec9);
        color: white;
        text-decoration: none;
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: 600;
        display: inline-block;
        margin-top: 20px;
        transition: all 0.3s ease;
      }

      .preview-download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 184, 148, 0.4);
      }

      .preview-loading {
        text-align: center;
        padding: 40px;
      }

      .preview-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .logout-btn {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 15px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
      }

      .file-size {
        color: #666;
        font-size: 0.9em;
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
      }

      .status-uploading {
        background: #d1ecf1;
        color: #0c5460;
      }

      .status-error {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div>
          <h1>üëë Admin Dashboard</h1>
          <div id="admin-info"></div>
        </div>
        <div class="admin-badge">
          <span>üõ°Ô∏è</span>
          <span id="current-admin">Admin User</span>
          <button class="logout-btn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>
      </div>

      <div class="nav-tabs">
        <button class="nav-tab active" onclick="showPanel('dashboard')">
          üìä Dashboard
        </button>
        <button class="nav-tab" onclick="showPanel('users')">
          üë• Qu·∫£n l√Ω Users
        </button>
        <button class="nav-tab" onclick="showPanel('files')">
          üìÅ Qu·∫£n l√Ω Files
        </button>
        <button class="nav-tab" onclick="showPanel('recycle')">
          üóëÔ∏è Th√πng r√°c
        </button>
        <button class="nav-tab" onclick="showPanel('settings')">
          ‚öôÔ∏è C√†i ƒë·∫∑t
        </button>
      </div>

      <!-- Dashboard Panel -->
      <div id="dashboard-panel" class="content-panel active">
        <h2>üìä Th·ªëng k√™ t·ªïng quan</h2>
        <div class="dashboard-grid">
          <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-number" id="total-users">0</div>
            <div class="stat-label">T·ªïng Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìÅ</div>
            <div class="stat-number" id="total-files">0</div>
            <div class="stat-label">T·ªïng Files</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üíæ</div>
            <div class="stat-number" id="total-size">0 MB</div>
            <div class="stat-label">T·ªïng dung l∆∞·ª£ng</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìà</div>
            <div class="stat-number" id="today-uploads">0</div>
            <div class="stat-label">Upload h√¥m nay</div>
          </div>
        </div>
      </div>

      <!-- Users Panel -->
      <div id="users-panel" class="content-panel">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2>üë• Qu·∫£n l√Ω Users</h2>
          <button class="btn btn-success" onclick="showCreateUserModal()">
            ‚ûï Th√™m User
          </button>
        </div>
        <input
          type="text"
          class="search-bar"
          placeholder="üîç T√¨m ki·∫øm user..."
          id="user-search"
          onkeyup="filterUsers()"
        />
        <div class="table-container">
          <table id="users-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Role</th>
                <th>Ng√†y t·∫°o</th>
                <th>ƒêƒÉng nh·∫≠p cu·ªëi</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="users-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Files Panel -->
      <div id="files-panel" class="content-panel">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2>üìÅ Qu·∫£n l√Ω Files</h2>
          <select id="file-user-filter" onchange="filterFiles()">
            <option value="">T·∫•t c·∫£ users</option>
          </select>
        </div>
        <input
          type="text"
          class="search-bar"
          placeholder="üîç T√¨m ki·∫øm file..."
          id="file-search"
          onkeyup="filterFiles()"
        />
        <div class="table-container">
          <table id="files-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>T√™n file</th>
                <th>Owner</th>
                <th>K√≠ch th∆∞·ªõc</th>
                <th>Ng√†y upload</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="files-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Recycle Bin Panel -->
      <div id="recycle-panel" class="content-panel">
        <h2>üóëÔ∏è Th√πng r√°c</h2>
        <p style="color: #666; margin-bottom: 20px">
          Files ƒë∆∞·ª£c gi·ªØ trong th√πng r√°c 30 ng√†y (admin files) ho·∫∑c 7 ng√†y (user
          files) tr∆∞·ªõc khi b·ªã x√≥a vƒ©nh vi·ªÖn.
        </p>
        <input
          type="text"
          class="search-bar"
          placeholder="üîç T√¨m ki·∫øm file trong th√πng r√°c..."
          id="recycle-search"
          onkeyup="filterRecycleFiles()"
        />
        <div class="table-container">
          <table id="recycle-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>T√™n file</th>
                <th>Owner</th>
                <th>K√≠ch th∆∞·ªõc</th>
                <th>Ng√†y x√≥a</th>
                <th>H·∫°n kh√¥i ph·ª•c</th>
                <th>X√≥a b·ªüi</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="recycle-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Settings Panel -->
      <div id="settings-panel" class="content-panel">
        <h2>‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng</h2>
        <div class="form-group">
          <label>üö´ X√≥a files c≈© h∆°n (ng√†y):</label>
          <input type="number" id="cleanup-days" value="30" min="1" />
          <button class="btn" onclick="cleanupOldFiles()">üßπ D·ªçn d·∫πp</button>
        </div>
        <div class="form-group">
          <label>üìä Export d·ªØ li·ªáu:</label>
          <button class="btn" onclick="exportUsers()">üì• Export Users</button>
          <button class="btn" onclick="exportFiles()">üì• Export Files</button>
        </div>
      </div>
    </div>

    <!-- Create User Modal -->
    <div id="create-user-modal" class="modal">
      <div class="modal-content">
        <h3>‚ûï Th√™m User m·ªõi</h3>
        <form id="create-user-form">
          <div class="form-group">
            <label>Username:</label>
            <input type="text" id="new-username" required />
          </div>
          <div class="form-group">
            <label>Password:</label>
            <input type="password" id="new-password" required />
          </div>
          <div class="form-group">
            <label>Role:</label>
            <select id="new-role" required>
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div style="text-align: right">
            <button
              type="button"
              class="btn"
              onclick="closeModal('create-user-modal')"
            >
              H·ªßy
            </button>
            <button type="submit" class="btn btn-success">T·∫°o User</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="preview-modal">
      <div class="preview-content">
        <div class="preview-header">
          <h3 id="previewTitle" class="preview-title">File Preview</h3>
          <button id="previewClose" class="preview-close">√ó</button>
        </div>
        <div id="previewBody" class="preview-body">
          <!-- Preview content will be loaded here -->
        </div>
      </div>
    </div>

    <script>
      let currentUser = null;
      let allUsers = [];
      let allFiles = [];
      let allRecycleFiles = [];

      // Initialize admin dashboard
      async function init() {
        try {
          // Check admin authentication
          const response = await fetch("/api/auth/check", {
            credentials: "include",
          });

          if (!response.ok) {
            window.location.href = "/login";
            return;
          }

          const data = await response.json();
          currentUser = data.user;

          // Check if user is admin
          if (currentUser.role !== "admin") {
            alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang admin!");
            window.location.href = "/";
            return;
          }

          document.getElementById("current-admin").textContent =
            currentUser.username;

          // Load data
          await loadDashboardStats();
          await loadUsers();
          await loadFiles();
          await loadRecycleFiles();
        } catch (error) {
          console.error("Admin init error:", error);
          window.location.href = "/login";
        }
      }

      // Load dashboard statistics
      async function loadDashboardStats() {
        try {
          const [usersResponse, filesResponse, statsResponse] =
            await Promise.all([
              fetch("/api/admin/users", { credentials: "include" }),
              fetch("/api/admin/files", { credentials: "include" }),
              fetch("/api/admin/stats", { credentials: "include" }),
            ]);

          const users = await usersResponse.json();
          const files = await filesResponse.json();
          const stats = await statsResponse.json();

          document.getElementById("total-users").textContent = users.length;
          document.getElementById("total-files").textContent = files.length;
          document.getElementById("total-size").textContent = formatFileSize(
            stats.total_size || 0
          );
          document.getElementById("today-uploads").textContent =
            stats.today_uploads || 0;
        } catch (error) {
          console.error("Error loading dashboard stats:", error);
        }
      }

      // Load users
      async function loadUsers() {
        try {
          const response = await fetch("/api/admin/users", {
            credentials: "include",
          });
          allUsers = await response.json();
          renderUsers(allUsers);
          populateUserFilter();
        } catch (error) {
          console.error("Error loading users:", error);
        }
      }

      // Load files
      async function loadFiles() {
        try {
          const response = await fetch("/api/admin/files", {
            credentials: "include",
          });
          allFiles = await response.json();
          renderFiles(allFiles);
        } catch (error) {
          console.error("Error loading files:", error);
        }
      }

      // Load recycle bin files
      async function loadRecycleFiles() {
        try {
          const response = await fetch("/api/admin/recycle-bin", {
            credentials: "include",
          });
          const data = await response.json();
          allRecycleFiles = data.files;
          renderRecycleFiles(allRecycleFiles);
        } catch (error) {
          console.error("Error loading recycle files:", error);
        }
      }

      // Render users table
      function renderUsers(users) {
        const tbody = document.getElementById("users-tbody");
        tbody.innerHTML = users
          .map(
            (user) => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td><span class="user-badge ${user.role}">${
              user.role
            }</span></td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>${
                      user.last_login
                        ? formatDate(user.last_login)
                        : "Ch∆∞a ƒëƒÉng nh·∫≠p"
                    }</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-warning" onclick="resetPassword(${
                              user.id
                            })">üîë Reset PW</button>
                            <button class="btn btn-danger" onclick="deleteUser(${
                              user.id
                            })">üóëÔ∏è X√≥a</button>
                        </div>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      // Render files table
      function renderFiles(files) {
        const tbody = document.getElementById("files-tbody");
        tbody.innerHTML = files
          .map(
            (file) => `
                <tr>
                    <td>${file.id}</td>
                    <td>${file.original_filename}</td>
                    <td>${file.username || "Unknown"}</td>
                    <td class="file-size">${formatFileSize(file.size)}</td>
                    <td>${formatDate(file.created_at)}</td>
                    <td><span class="status-badge status-${file.status}">${
              file.status
            }</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-preview" onclick="previewFile(${
                              file.id
                            }, '${file.original_filename}')">üëÅÔ∏è Preview</button>
                            <button class="btn-download" onclick="downloadFile(${
                              file.id
                            })">‚¨áÔ∏è Download</button>
                            <button class="btn btn-danger" onclick="deleteFile(${
                              file.id
                            })">üóëÔ∏è X√≥a</button>
                        </div>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      // Render recycle bin files table
      function renderRecycleFiles(files) {
        const tbody = document.getElementById("recycle-tbody");
        tbody.innerHTML = files
          .map((file) => {
            const daysLeft = Math.ceil(
              (new Date(file.restore_deadline) - new Date()) /
                (1000 * 60 * 60 * 24)
            );
            const deadlineColor =
              daysLeft <= 3
                ? "color: red; font-weight: bold;"
                : daysLeft <= 7
                ? "color: orange;"
                : "";

            return `
                <tr>
                    <td>${file.id}</td>
                    <td>${file.original_filename}</td>
                    <td>${file.owner_name || "Unknown"}</td>
                    <td class="file-size">${formatFileSize(file.size)}</td>
                    <td>${formatDate(file.deleted_at)}</td>
                    <td style="${deadlineColor}">${formatDate(
              file.restore_deadline
            )} (${daysLeft} ng√†y)</td>
                    <td>${file.deleted_by_name || "Unknown"}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn" onclick="restoreFile(${
                              file.id
                            })" style="background: linear-gradient(45deg, #2ecc71, #27ae60); color: white;">
                              ‚ôªÔ∏è Kh√¥i ph·ª•c
                            </button>
                            <button class="btn btn-danger" onclick="permanentlyDeleteFile(${
                              file.id
                            })">
                              üíÄ X√≥a vƒ©nh vi·ªÖn
                            </button>
                        </div>
                    </td>
                </tr>
            `;
          })
          .join("");
      }

      // Panel navigation
      function showPanel(panelName) {
        // Hide all panels
        document.querySelectorAll(".content-panel").forEach((panel) => {
          panel.classList.remove("active");
        });

        // Remove active from all tabs
        document.querySelectorAll(".nav-tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected panel
        document.getElementById(panelName + "-panel").classList.add("active");
        event.target.classList.add("active");
      }

      // User management functions
      async function createUser(username, password, role) {
        try {
          const response = await fetch("/api/admin/users", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ username, password, role }),
          });

          if (response.ok) {
            alert("User ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!");
            closeModal("create-user-modal");
            await loadUsers();
            await loadDashboardStats();
          } else {
            const error = await response.json();
            alert("L·ªói: " + error.error);
          }
        } catch (error) {
          console.error("Error creating user:", error);
          alert("C√≥ l·ªói x·∫£y ra khi t·∫°o user");
        }
      }

      async function deleteUser(userId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a user n√†y?")) return;

        try {
          const response = await fetch(`/api/admin/users/${userId}`, {
            method: "DELETE",
            credentials: "include",
          });

          if (response.ok) {
            alert("User ƒë√£ ƒë∆∞·ª£c x√≥a!");
            await loadUsers();
            await loadDashboardStats();
          } else {
            alert("C√≥ l·ªói x·∫£y ra khi x√≥a user");
          }
        } catch (error) {
          console.error("Error deleting user:", error);
        }
      }

      async function resetPassword(userId) {
        const newPassword = prompt("Nh·∫≠p m·∫≠t kh·∫©u m·ªõi:");
        if (!newPassword) return;

        try {
          const response = await fetch(
            `/api/admin/users/${userId}/reset-password`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ password: newPassword }),
            }
          );

          if (response.ok) {
            alert("M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c reset!");
          } else {
            alert("C√≥ l·ªói x·∫£y ra khi reset m·∫≠t kh·∫©u");
          }
        } catch (error) {
          console.error("Error resetting password:", error);
        }
      }

      // File management functions
      async function downloadFile(fileId) {
        try {
          console.log(`üîΩ Downloading file ${fileId}...`);

          // S·ª≠ d·ª•ng fetch v·ªõi credentials ƒë·ªÉ ƒë·∫£m b·∫£o authentication
          const response = await fetch(`/api/files/${fileId}/download`, {
            method: "GET",
            credentials: "include",
          });

          if (!response.ok) {
            const errorData = await response.json();
            console.error("Download error:", errorData);
            alert(`L·ªói download: ${errorData.error || "Unknown error"}`);
            return;
          }

          // L·∫•y filename t·ª´ Content-Disposition header ho·∫∑c d√πng default
          const contentDisposition = response.headers.get(
            "Content-Disposition"
          );
          let filename = "download";
          if (contentDisposition) {
            const filenameMatch =
              contentDisposition.match(/filename="?([^"]+)"?/);
            if (filenameMatch) {
              filename = filenameMatch[1];
            }
          }

          // Convert response to blob v√† t·∫°o download link
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);

          const link = document.createElement("a");
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          // Clean up blob URL
          window.URL.revokeObjectURL(url);

          console.log(`‚úÖ File ${filename} downloaded successfully`);
        } catch (error) {
          console.error("Error downloading file:", error);
          alert("C√≥ l·ªói x·∫£y ra khi t·∫£i file");
        }
      }

      async function previewFile(fileId, fileName) {
        try {
          // Get file info first
          const infoResponse = await fetch(`/api/files/${fileId}/info`, {
            credentials: "include",
          });
          if (!infoResponse.ok) {
            throw new Error(`Failed to get file info: ${infoResponse.status}`);
          }

          const fileInfo = await infoResponse.json();
          showPreviewModal(fileInfo);
        } catch (error) {
          console.error("Error previewing file:", error);
          alert(`Error previewing file: ${error.message}`);
        }
      }

      // Show preview modal
      function showPreviewModal(fileInfo) {
        const modal = document.getElementById("previewModal");
        const title = document.getElementById("previewTitle");
        const body = document.getElementById("previewBody");

        title.textContent = fileInfo.name;

        // Show loading first
        body.innerHTML = `
          <div class="preview-loading">
            <div class="preview-spinner"></div>
            <p>Loading preview...</p>
          </div>
        `;

        modal.classList.add("active");

        // Setup close button
        const closeBtn = document.getElementById("previewClose");
        closeBtn.onclick = () => {
          modal.classList.remove("active");
        };

        // Close on outside click
        modal.onclick = (e) => {
          if (e.target === modal) {
            modal.classList.remove("active");
          }
        };

        // Load preview content
        setTimeout(() => {
          loadPreviewContent(fileInfo, body);
        }, 500);
      }

      // Load preview content based on file type
      function loadPreviewContent(fileInfo, container) {
        const { preview_type, preview_url, name, size, id } = fileInfo;

        switch (preview_type) {
          case "image":
            container.innerHTML = `
              <img src="${preview_url}" alt="${name}" class="preview-image" 
                   onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
              <div style="display:none;" class="preview-download">
                <div class="preview-icon">üñºÔ∏è</div>
                <div class="preview-download-info">
                  <h3>Image Preview Failed</h3>
                  <p>Cannot display this image</p>
                  <p><strong>Size:</strong> ${formatFileSize(size)}</p>
                </div>
                <a href="/api/files/${id}/download" class="preview-download-btn">
                  ‚¨áÔ∏è Download
                </a>
              </div>
            `;
            break;

          case "pdf":
            container.innerHTML = `
              <iframe src="${preview_url}" class="preview-pdf" 
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
              </iframe>
              <div style="display:none;" class="preview-download">
                <div class="preview-icon">üìÑ</div>
                <div class="preview-download-info">
                  <h3>PDF Preview Not Available</h3>
                  <p>Your browser doesn't support PDF preview</p>
                  <p><strong>Size:</strong> ${formatFileSize(size)}</p>
                </div>
                <a href="/api/files/${id}/download" class="preview-download-btn">
                  ‚¨áÔ∏è Download PDF
                </a>
              </div>
            `;
            break;

          case "video":
            container.innerHTML = `
              <video src="${preview_url}" class="preview-video" controls 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                Your browser does not support video playback.
              </video>
              <div style="display:none;" class="preview-download">
                <div class="preview-icon">üé¨</div>
                <div class="preview-download-info">
                  <h3>Video Preview Failed</h3>
                  <p>Cannot play this video format</p>
                  <p><strong>Size:</strong> ${formatFileSize(size)}</p>
                </div>
                <a href="/api/files/${id}/download" class="preview-download-btn">
                  ‚¨áÔ∏è Download Video
                </a>
              </div>
            `;
            break;

          case "audio":
            container.innerHTML = `
              <audio src="${preview_url}" class="preview-audio" controls 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                Your browser does not support audio playback.
              </audio>
              <div style="display:none;" class="preview-download">
                <div class="preview-icon">üéµ</div>
                <div class="preview-download-info">
                  <h3>Audio Preview Failed</h3>
                  <p>Cannot play this audio format</p>
                  <p><strong>Size:</strong> ${formatFileSize(size)}</p>
                </div>
                <a href="/api/files/${id}/download" class="preview-download-btn">
                  ‚¨áÔ∏è Download Audio
                </a>
              </div>
            `;
            break;

          case "text":
            // Load text content
            fetch(preview_url, { credentials: "include" })
              .then((response) => response.text())
              .then((text) => {
                container.innerHTML = `<pre class="preview-text">${escapeHtml(
                  text.substring(0, 10000)
                )}</pre>`;
              })
              .catch(() => {
                container.innerHTML = getDownloadOnlyPreview(
                  fileInfo,
                  "üìù",
                  "Text Preview Failed",
                  "Cannot load text file"
                );
              });
            return;

          default:
            container.innerHTML = getDownloadOnlyPreview(
              fileInfo,
              "üìé",
              "Preview Not Available",
              `${fileInfo.extension || "This file type"} cannot be previewed`
            );
            break;
        }
      }

      // Helper function for download-only preview
      function getDownloadOnlyPreview(fileInfo, icon, title, subtitle) {
        return `
          <div class="preview-download">
            <div class="preview-icon">${icon}</div>
            <div class="preview-download-info">
              <h3>${title}</h3>
              <p>${subtitle}</p>
              <p><strong>Size:</strong> ${formatFileSize(fileInfo.size)}</p>
            </div>
            <a href="/api/files/${
              fileInfo.id
            }/download" class="preview-download-btn">
              ‚¨áÔ∏è Download
            </a>
          </div>
        `;
      }

      // Helper function to escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
      async function deleteFile(fileId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a file n√†y?")) return;

        try {
          const response = await fetch(`/api/admin/files/${fileId}`, {
            method: "DELETE",
            credentials: "include",
          });

          if (response.ok) {
            alert("File ƒë√£ ƒë∆∞·ª£c x√≥a!");
            await loadFiles();
            await loadDashboardStats();
          } else {
            alert("C√≥ l·ªói x·∫£y ra khi x√≥a file");
          }
        } catch (error) {
          console.error("Error deleting file:", error);
        }
      }

      // Filter functions
      function filterUsers() {
        const search = document
          .getElementById("user-search")
          .value.toLowerCase();
        const filtered = allUsers.filter(
          (user) =>
            user.username.toLowerCase().includes(search) ||
            user.role.toLowerCase().includes(search)
        );
        renderUsers(filtered);
      }

      function filterFiles() {
        const search = document
          .getElementById("file-search")
          .value.toLowerCase();
        const userFilter = document.getElementById("file-user-filter").value;

        let filtered = allFiles.filter((file) =>
          file.original_filename.toLowerCase().includes(search)
        );

        if (userFilter) {
          filtered = filtered.filter((file) => file.user_id == userFilter);
        }

        renderFiles(filtered);
      }

      function filterRecycleFiles() {
        const search = document
          .getElementById("recycle-search")
          .value.toLowerCase();

        const filtered = allRecycleFiles.filter(
          (file) =>
            file.original_filename.toLowerCase().includes(search) ||
            (file.owner_name && file.owner_name.toLowerCase().includes(search))
        );

        renderRecycleFiles(filtered);
      }

      // Recycle bin operations
      async function restoreFile(recycleId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën kh√¥i ph·ª•c file n√†y?")) return;

        try {
          const response = await fetch(
            `/api/recycle-bin/${recycleId}/restore`,
            {
              method: "POST",
              credentials: "include",
            }
          );

          if (response.ok) {
            alert("File ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c th√†nh c√¥ng!");
            await loadRecycleFiles();
            await loadFiles();
            await loadDashboardStats();
          } else {
            const error = await response.json();
            alert("L·ªói: " + (error.error || "Kh√¥ng th·ªÉ kh√¥i ph·ª•c file"));
          }
        } catch (error) {
          console.error("Error restoring file:", error);
          alert("C√≥ l·ªói x·∫£y ra khi kh√¥i ph·ª•c file");
        }
      }

      async function permanentlyDeleteFile(recycleId) {
        if (
          !confirm(
            "‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA Vƒ®NH VI·ªÑN file n√†y?\n\nFile s·∫Ω b·ªã x√≥a ho√†n to√†n v√† KH√îNG TH·∫∫ KH√îI PH·ª§C!"
          )
        )
          return;

        try {
          const response = await fetch(`/api/recycle-bin/${recycleId}/delete`, {
            method: "DELETE",
            credentials: "include",
          });

          if (response.ok) {
            alert("File ƒë√£ ƒë∆∞·ª£c x√≥a vƒ©nh vi·ªÖn!");
            await loadRecycleFiles();
            await loadDashboardStats();
          } else {
            const error = await response.json();
            alert("L·ªói: " + (error.error || "Kh√¥ng th·ªÉ x√≥a vƒ©nh vi·ªÖn file"));
          }
        } catch (error) {
          console.error("Error permanently deleting file:", error);
          alert("C√≥ l·ªói x·∫£y ra khi x√≥a vƒ©nh vi·ªÖn file");
        }
      }

      function populateUserFilter() {
        const select = document.getElementById("file-user-filter");
        select.innerHTML =
          '<option value="">T·∫•t c·∫£ users</option>' +
          allUsers
            .map(
              (user) => `<option value="${user.id}">${user.username}</option>`
            )
            .join("");
      }

      // Modal functions
      function showCreateUserModal() {
        document.getElementById("create-user-modal").style.display = "block";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // Utility functions
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function formatDate(dateString) {
        if (!dateString) return "";
        return new Date(dateString).toLocaleDateString("vi-VN");
      }

      async function logout() {
        try {
          await fetch("/api/logout", {
            method: "POST",
            credentials: "include",
          });
          window.location.href = "/login";
        } catch (error) {
          console.error("Logout error:", error);
        }
      }

      // Event listeners
      document
        .getElementById("create-user-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const username = document.getElementById("new-username").value;
          const password = document.getElementById("new-password").value;
          const role = document.getElementById("new-role").value;
          createUser(username, password, role);
        });

      // Close modal when clicking outside
      window.addEventListener("click", function (e) {
        const modals = document.querySelectorAll(".modal");
        modals.forEach((modal) => {
          if (e.target === modal) {
            modal.style.display = "none";
          }
        });
      });

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
